---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: postgresql
  namespace: gitea
spec:
  interval: 30m
  chart:
    spec:
      chart: postgresql
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 30m
  values:
    global:
      postgresql: {}
    auth:
      database: gitea
      existingSecret: postgresql-secret
      # secretKeys:
      #   adminPasswordKey: postgres-password
      #   userPasswordKey: password
      #   # doesn't matter, there's no replication happening
      #   replicationPasswordKey: replication-password
      username: gitea
    primary:
      containerSecurityContext:
        runAsUser: 1000
      persistence:
        existingClaim: postgresql-volume-claim
      podSecurityContext:
        fsGroup: 1000
    tls:
      enabled: true
      autoGenerated: true
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgresql-volume-claim
  namespace: gitea
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: local-storage
  volumeName: gitea-postgresql-volume
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitea-postgresql-volume
spec:
  accessModes:
    - ReadWriteOnce
  claimRef:
    name: postgresql-volume-claim
    namespace: gitea
  hostPath:
    path: /data/gitea/postgresql
    type: Directory
  capacity:
    storage: 50Gi
  # persistentVolumeReclaimPolicy: Retain # <- default
  storageClassName: local-storage
  volumeMode: Filesystem
---
